using System;
using System.Collections.Generic;
using System.Text;

namespace JiraFhirUtils.SQLiteGenerator;

public class GeneratorJsonUtils
{

    internal const string JfSQLiteUtils = $$$"""
        //------------------------------------------------------------------------------
        // <auto-generated>
        //     This code was generated by a tool.
        //
        //     Changes to this file may cause incorrect behavior and will be lost if
        //     the code is regenerated.
        // </auto-generated>
        //------------------------------------------------------------------------------
        
        #nullable enable

        using System.Collections.Generic;
        using System.Diagnostics.CodeAnalysis;
        using System.Text.Json;
                        
        namespace JiraFhirUtils.SQLiteGenerator
        {
            public static class JfSQLiteUtils
            {
                public enum JfNumericOperatorCodes : int
                {
                    Equals = 0,
                    NotEquals = 1,
                    GreaterThan = 2,
                    GreaterThanOrEquals = 3,
                    LessThan = 4,
                    LessThanOrEquals = 5,
                }
                
                public static string GetSqlOperator(JfNumericOperatorCodes op) => op switch
                {
                    JfNumericOperatorCodes.Equals => "=",
                    JfNumericOperatorCodes.NotEquals => "!=",
                    JfNumericOperatorCodes.GreaterThan => ">",
                    JfNumericOperatorCodes.GreaterThanOrEquals => ">=",
                    JfNumericOperatorCodes.LessThan => "<",
                    JfNumericOperatorCodes.LessThanOrEquals => "<=",
                    _ => throw new NotSupportedException($"Unsupported operator code: {op}"),
                };
            
                private static System.Text.RegularExpressions.Regex _htmlStripRegex = new("<.*?>", System.Text.RegularExpressions.RegexOptions.Compiled);

                private static JsonSerializerOptions _options = new JsonSerializerOptions()
                {
                    WriteIndented = false,
                };

                public static bool TrySerializeForDb<T>(T? instance, [NotNullWhen(true)]out string? json) where T : class
                {
                    if (instance == null)
                    {
                        json = null;
                        return false;
                    }

                    json = JsonSerializer.Serialize(instance, _options);
                    return true;
                }

                public static bool TrySerializeForDb<T>(List<T>? instances, [NotNullWhen(true)] out string? json) where T : class
                {
                    if ((instances == null) || (instances.Count == 0))
                    {
                        json = null;
                        return false;
                    }

                    // Serialize the FHIR model instance to a JSON string
                    json = JsonSerializer.Serialize(instances, _options);
                    return true;
                }

                public static T? ParseFromDb<T>(string json) where T : class
                {
                    if (string.IsNullOrWhiteSpace(json))
                    {
                        return null;
                    }

                    // Parse the JSON string into a FHIR model instance of type T
                    return JsonSerializer.Deserialize<T>(json, _options);
                }

                public static List<T> ParseArrayFromDb<T>(string json) where T : class
                {
                    if (string.IsNullOrWhiteSpace(json))
                    {
                        return new List<T>();
                    }

                    return JsonSerializer.Deserialize<List<T>>(json, _options) ?? [];
                }

                public static string StripHtml(string? input)
                {
                    if (string.IsNullOrWhiteSpace(input))
                    {
                        return string.Empty;
                    }

                    return _htmlStripRegex.Replace(input, string.Empty).Trim();
                }
            }
        }
        #nullable restore
        """;
}
